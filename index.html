<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¨å‹™ç›¸è«‡AIãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã®ãƒ‡ã‚¶ã‚¤ãƒ³å®šç¾© (ç¶­æŒ) --- */
        :root {
            --text-dark-1: #333333;
            --text-light-1: #FFFFFF;
            --text-dark-2: #79B9E1;
            --accent-1: #1B2A4C; /* æ¿ƒã„ç´ºè‰² */
            --accent-2: #79B9E1; /* æ°´è‰² */
            --accent-3: #C0C0C0;
            --accent-4: #A9A9A9;
            --accent-5: #808080;
            --accent-6: #568FBB; /* ãƒœã‚¿ãƒ³ç­‰ã®é’ */
            --link: #568FBB;
        }

        body { 
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            color: var(--text-dark-1);
            background-color: #f5f6f7;
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f0f0f0; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--accent-3); border-radius: 4px; }
        
        /* ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ç­‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .bot-message h2 { font-size: 1.1rem; font-weight: 700; margin: 1.5rem 0 0.5rem; color: var(--accent-1); border-bottom: 1px solid var(--accent-2); padding-bottom: 0.25rem; }
        .bot-message h3 { font-size: 1rem; font-weight: 600; margin: 1rem 0 0.5rem; color: var(--accent-6); }
        .bot-message ul { list-style-type: disc; padding-left: 1.5rem; margin: 0.5rem 0; }
        .bot-message p { margin-bottom: 0.5rem; line-height: 1.7; }
        .bot-message strong { color: var(--accent-1); background: rgba(121, 185, 225, 0.1); padding: 0 2px; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .header-gradient {
            background: linear-gradient(135deg, var(--accent-1) 0%, #2C4375 100%);
        }

        /* ç¨ç›®ãƒãƒƒã‚¸ */
        .tax-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: var(--accent-6);
            color: var(--text-light-1);
        }

        /* å‚ç…§å…ƒã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« (æ–°è¦è¿½åŠ ) */
        .ref-container { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; }
        .ref-title { font-size: 0.75rem; font-weight: 700; color: var(--accent-5); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.25rem; }
        .ref-card { 
            display: block; padding: 0.5rem; margin-bottom: 0.5rem; 
            background: #fff; border: 1px solid #e5e7eb; border-radius: 0.5rem; 
            border-left: 3px solid var(--accent-2); text-decoration: none; transition: all 0.2s;
        }
        .ref-card:hover { transform: translateX(2px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .ref-source { font-size: 0.7rem; color: var(--accent-6); font-weight: bold; }
        .ref-text { font-size: 0.8rem; color: var(--text-dark-1); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .typing span { display: inline-block; width: 6px; height: 6px; background-color: var(--accent-6); border-radius: 50%; animation: typing 1.4s infinite; margin: 0 2px; }
        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 100% { opacity: 0.2; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center p-0 md:p-4">

    <div class="w-full max-w-4xl bg-white md:rounded-2xl shadow-2xl overflow-hidden flex flex-col h-full md:h-[90vh]">
        <div class="header-gradient p-6 text-white shrink-0">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[#79B9E1]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                        ç¨å‹™ç›¸è«‡AIãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ
                    </h1>
                    <p class="text-sm mt-1 text-[#79B9E1]">æ³•äººç¨ãƒ»æ‰€å¾—ç¨ãƒ»æ¶ˆè²»ç¨ãƒ»ç›¸ç¶šç¨ãƒ»å›ºå®šè³‡ç”£ç¨ãƒ»ä½æ°‘ç¨ã«å¯¾å¿œ</p>
                </div>
                <button onclick="location.reload()" class="text-white hover:bg-white/20 transition-colors p-2 rounded-lg" title="ãƒãƒ£ãƒƒãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
            </div>
        </div>

        <div id="messages" class="flex-1 overflow-y-auto custom-scrollbar p-6 bg-white">
            <div class="flex items-start mb-6">
                <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center text-white font-bold shadow-md mr-3" style="background-color: var(--accent-1);">
                    AI
                </div>
                <div class="flex-1 rounded-2xl rounded-tl-none p-5 max-w-3xl" style="background-color: #f8f9fa;">
                    <p class="mb-3 font-medium text-gray-800">
                        ã“ã‚“ã«ã¡ã¯ï¼ç¨å‹™ç›¸è«‡AIãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ã™ã€‚ä»¥ä¸‹ã®ç¨ç›®ã«ã¤ã„ã¦ã”è³ªå•ã‚’ãŠå—ã‘ã—ã¾ã™ï¼š
                    </p>
                    <div class="flex flex-wrap gap-1 mb-4">
                        <span class="tax-badge">æ³•äººç¨</span>
                        <span class="tax-badge">æ‰€å¾—ç¨</span>
                        <span class="tax-badge">æ¶ˆè²»ç¨</span>
                        <span class="tax-badge">ç›¸ç¶šç¨</span>
                        <span class="tax-badge">å›ºå®šè³‡ç”£ç¨</span>
                        <span class="tax-badge">ä½æ°‘ç¨</span>
                    </div>
                    <p class="text-sm text-gray-500">
                        ã©ã®ã‚ˆã†ãªç¨å‹™ã®ã”è³ªå•ã§ã‚‚ãŠæ°—è»½ã«ã©ã†ãã€‚è³ªå•å†…å®¹ã‹ã‚‰ç¨ç›®ã‚’è‡ªå‹•çš„ã«åˆ¤å®šã—ã¦ãŠç­”ãˆã—ã¾ã™ã€‚
                    </p>
                </div>
            </div>
        </div>

        <div class="p-4 bg-[#f8f9fa] border-t border-gray-200 shrink-0">
            <form id="chat-form" class="flex items-center gap-3 max-w-4xl mx-auto">
                <input
                    type="text"
                    id="user-input"
                    class="flex-1 px-4 py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#79B9E1] border border-gray-300 transition-all shadow-sm"
                    placeholder="ç¨å‹™ã«é–¢ã™ã‚‹è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
                    autocomplete="off"
                    required
                />
                <button
                    type="submit"
                    id="send-btn"
                    class="px-6 py-3 font-medium rounded-xl focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-2 text-white shadow-md hover:bg-[#568FBB]"
                    style="background-color: var(--accent-1);"
                >
                    <span>é€ä¿¡</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                    </svg>
                </button>
            </form>
            <p class="text-xs mt-2 text-center text-gray-400">
                â€» æœ¬å›ç­”ã¯RAGæŠ€è¡“ã«ã‚ˆã‚Šå›½ç¨åºãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç­‰ã‚’å‚ç…§ã—ã¦ã„ã¾ã™ãŒã€AIã«ã‚ˆã‚‹å›ç­”ã®ãŸã‚èª¤ã‚Šã‚’å«ã‚€å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
            </p>
        </div>
    </div>

    <script>
        // â–¼â–¼â–¼ n8nã®Webhook URLã‚’ã“ã“ã«è¨­å®šã—ã¦ãã ã•ã„ â–¼â–¼â–¼
        const WEBHOOK_URL = 'https://my-n8n.xvps.jp/webhook/tax-chatbot-v2';
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
        
        const sessionId = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const messagesDiv = document.getElementById('messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const chatForm = document.getElementById('chat-form');

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ é–¢æ•° (RAGãƒ¬ã‚¹ãƒãƒ³ã‚¹å¯¾å¿œ)
        function addMessage(role, content, metadata = {}) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start mb-6 animate-fade-in';

            if (role === 'user') {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                messageDiv.innerHTML = `
                    <div class="flex-1 flex justify-end">
                        <div class="rounded-2xl rounded-br-none p-4 max-w-2xl bg-[#568FBB] text-white shadow-md">
                            ${escapeHtml(content)}
                        </div>
                    </div>
                    <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center font-bold ml-3 bg-gray-300 text-[#1B2A4C]">
                        You
                    </div>
                `;
            } else {
                // AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (RAGãƒ‡ãƒ¼ã‚¿å‡¦ç†)
                let referencesHTML = '';
                
                // 1. å‚ç…§å…ƒ (å›½ç¨åºURLãªã©) ã®è¡¨ç¤ºç”Ÿæˆ
                if (metadata.references && metadata.references.length > 0) {
                    referencesHTML += `<div class="ref-container"><div class="ref-title">ğŸ” æ ¹æ‹ ãƒ»å‚è€ƒãƒªãƒ³ã‚¯</div>`;
                    metadata.references.forEach(ref => {
                        referencesHTML += `
                            <a href="${ref.url}" target="_blank" class="ref-card">
                                <div class="ref-source">${ref.source || 'å›½ç¨åºWeb'}</div>
                                <div class="ref-text">${ref.title}</div>
                            </a>`;
                    });
                    referencesHTML += `</div>`;
                }

                // 2. åˆ¤ä¾‹ã®è¡¨ç¤ºç”Ÿæˆ
                if (metadata.precedents && metadata.precedents.length > 0) {
                    referencesHTML += `<div class="ref-container"><div class="ref-title">âš–ï¸ é–¢é€£ã™ã‚‹è£åˆ¤ä¾‹</div>`;
                    metadata.precedents.forEach(pre => {
                        referencesHTML += `
                            <div class="ref-card" style="border-left-color: #A9A9A9;">
                                <div class="ref-source">${pre.caseName}</div>
                                <div class="ref-text text-xs whitespace-normal">${pre.summary}</div>
                            </div>`;
                    });
                    referencesHTML += `</div>`;
                }

                // ç¨ç›®ãƒãƒƒã‚¸
                const taxBadge = metadata.taxType ? `<span class="inline-block px-2 py-0.5 bg-blue-100 text-[#1B2A4C] text-xs font-bold rounded-full mb-2">${metadata.taxType}</span>` : '';

                messageDiv.innerHTML = `
                    <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center text-white font-bold shadow-md mr-3" style="background-color: var(--accent-1);">
                        AI
                    </div>
                    <div class="flex-1 rounded-2xl rounded-tl-none p-5 max-w-3xl bg-[#f8f9fa] bot-message shadow-sm border border-gray-100">
                        ${taxBadge}
                        <div class="prose prose-sm max-w-none text-gray-800">
                            ${marked.parse(content)}
                        </div>
                        ${referencesHTML}
                    </div>
                `;
            }

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading';
            loadingDiv.className = 'flex items-start mb-6';
            loadingDiv.innerHTML = `
                <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center text-white font-bold shadow-md mr-3" style="background-color: var(--accent-1);">
                    AI
                </div>
                <div class="rounded-2xl rounded-tl-none p-4 bg-[#f8f9fa] typing shadow-sm border border-gray-100">
                    <span></span><span></span><span></span>
                </div>
            `;
            messagesDiv.appendChild(loadingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function hideLoading() {
            const loadingDiv = document.getElementById('loading');
            if (loadingDiv) loadingDiv.remove();
        }

        // é€ä¿¡å‡¦ç†
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const question = userInput.value.trim();
            if (!question) return;

            addMessage('user', question);
            userInput.value = '';
            sendBtn.disabled = true;
            userInput.disabled = true;
            
            showLoading();

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: question,
                        sessionId: sessionId
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const result = await response.json();
                hideLoading();

                // n8nã‹ã‚‰ã®JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è§£æ
                // æœŸå¾…ã•ã‚Œã‚‹å½¢å¼: { taxType: "", answer: "", references: [], precedents: [] }
                addMessage('assistant', result.answer || "å›ç­”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚", {
                    taxType: result.taxType,
                    references: result.references,
                    precedents: result.precedents
                });

            } catch (error) {
                console.error('Error:', error);
                hideLoading();
                addMessage('assistant', 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            } finally {
                sendBtn.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            }
        });
    </script>
</body>
</html>